<div id="quick-personal">
    <span class="hide"><a href="#skipnav"><&|/l&>Skip Menu</&></a> | </span>
% if ( $public_user ) {
    <&|/l&>You are currently an anonymous guest.</&>
    | <a href="<% RT->Config->Get('WebPath') %>/NoAuth/Logout.html?URL=<% $return_url %>"><&|/l&>Login</&></a>
    | <a href="<% RT->Config->Get('WebPath') %>/NoAuth/Logout.html"><&|/l&>Return to Main</&></a>
% } elsif ( $logged_in ) {
    <% loc("Logged in as [_1]", "<span>".$m->interp->apply_escapes($session{'CurrentUser'}->Name,'h')."</span>") |n %>
% } else {
    <&|/l&>Not logged in.</&>
% }
% if ( $can_modify_self ) {
    | <a href="<%RT->Config->Get('WebPath')%><% $Prefs %>"><&|/l&>Preferences</&></a>
% }
% $m->callback( %ARGS );
% if ( $logged_in && !$public_user ) {
<& Logout, %ARGS &>
% }
</div>
<%ARGS>
$Prefs => '/Prefs/Other.html'
</%ARGS>
<%INIT>
my $logged_in = $session{'CurrentUser'} && $session{'CurrentUser'}->Name;
my ($can_modify_self, $public_user, $return_url) = (0, 0, '');
if ( $logged_in ) {
    $can_modify_self = $session{'CurrentUser'}->HasRight(
        Right => 'ModifySelf', Object => $RT::System,
    ) if $Prefs;
    $public_user = $logged_in eq RT->Config->Get('WebPublicUser');
}

if ( $public_user ) {
    $return_url =
        RT->Config->Get('WebPath')
        . '/index.html?goto='
        . URI::Escape::uri_escape( URI::Escape::uri_escape(
            RT->Config->Get('WebPath')
            . $m->request_path
            . '?'
            . $m->comp('/Elements/QueryString', %{$r->args})
        ) );
}
</%INIT>
